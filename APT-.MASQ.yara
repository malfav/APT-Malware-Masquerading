import "pe"
import "console"
import "math"
import "hash"
rule APT_Strings_and_Network_IOCs {
	meta :
		author = "diyar saadi"
		threat_actor = "APT"	
	strings:
		$a = "microsoft.updatei.com"
		$a1 = "bitsadmin /cancel pdj"
		$a2 = "bitsadmin /SetPriority pdj HIGH"
		$a3 = "bitsadmin /addfile pdj"
		$pdb_path = "C:\\Users\\ja\\Documents\\Visual Studio 2015\\Projects\\mklg -binder\\Release\\mklg-binder.pdb"
		$b = " application/x-www-form-urlencoded/ech/echo.php?req=rr&u="
		$b1 = "WinHTTP"
		$b2 = "/ech/echo.php?req=rr&u="
		$b3 = "POST"
		$b4 = "form-data; name=uploadedfile; filename="
		$c =  ".doc"
		$c1 = ".pdf"
		$c2 = ".xls"
		$c3 = ".txt"
		$c4 = ".pgp"
		$pdb_full_name = "svchost.pdb"
	condition:
	console.log("The MD5 Hash:", hash.md5(0, filesize)) and 
	console.log("The SHA256 Hash:", hash.sha256(0, filesize))
	and (4 of ($a*) and $pdb_path and all of ($b*) and $pdb_full_name 
	and 
	3 of ($c*) ) and filesize > 2MB 
	and (pe.pdb_path contains "C:\\Users\\ja\\Documents\\") 
}
rule Entropy_and_Signature {
	meta :
		author = "diyar saadi"
		threat_actor = "APT"	
	condition:
		console.log("THE DLL Name : ", pe.dll_name) and
		console.log("Malware Entry Point : ", pe.entry_point) and
		console.log("Number Of Sections : ", pe.number_of_sections) and
		console.log("Number Of Resources : ", pe.number_of_resources) and
		console.hex("The Magic Header : ", uint16(0)) and
		console.log("IS AMD64 : ", pe.MACHINE_AMD64) and
		pe.number_of_signatures == 0 and
		math.entropy(0, filesize) > 7.1 		
}
rule APT_SCVSHOST{
	strings:
		$p_name = "svchost.exe"
		$i_name = "svchost.exe"
		$o_name = "svchost.exe"
	condition:
		pe.version_info["InternalName"] icontains "svchost.exe" or 
		pe.version_info["OrginalFileName"] icontains "svchost.exe" and
		$p_name and $i_name and $o_name and (pe.number_of_exports ==0)
}
rule APT_Anti_Virus_Process_Name{
	strings:
		$bitdefender = "bdagent.exe"
		$kaspersky = "avp.exe"
	condition:
			2 of them
}
rule APT_Run_As_Both_Priv_Level{
	strings:
		$invoker = "<requestedExecutionLevel level='asInvoker' uiAccess='false' />"
		$invoker2 = "</requestedPrivileges>"
		$invoker3 = "<assembly xmlns='urn:schemas-microsoft-com:asm.v1' manifestVersion='1.0'>"
		$invoker4 = "<requestedPrivileges>"
		$invoker5 = " </trustInfo>"
		$invoker6 = "<trustInfo xmlns=urn:schemas-microsoft-com:asm.v3>"
	condition:
		
		 5 of ($invoker*)
}